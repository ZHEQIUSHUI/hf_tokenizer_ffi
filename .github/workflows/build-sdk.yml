name: build-sdks

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:

permissions:
  contents: write
  actions: read

env:
  FIXED_TAG: v0.1.0

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]

    steps:
      - uses: actions/checkout@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.arch }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache ARM toolchain
        if: ${{ matrix.arch == 'aarch64' }}
        uses: actions/cache@v4
        with:
          path: |
            build_aarch64/gcc-arm-9.2-2019.12-x86_64-aarch64-none-linux-gnu.tar.xz
            build_aarch64/gcc-arm-9.2-2019.12-x86_64-aarch64-none-linux-gnu
          key: ${{ runner.os }}-arm-gcc-9.2-2019.12

      - name: Build SDK (x86_64)
        if: ${{ matrix.arch == 'x86_64' }}
        env:
          TARGET: x86_64-unknown-linux-gnu
          SDK_NAME: hf-tokenizer-sdk-x86_64
          OUT_DIR: dist
        run: |
          bash scripts/build_sdk_x86_64.sh

      - name: Build SDK (aarch64)
        if: ${{ matrix.arch == 'aarch64' }}
        env:
          BUILD_DIR: build_aarch64
          TARGET: aarch64-unknown-linux-gnu
          SDK_NAME: hf-tokenizer-sdk-aarch64
          OUT_DIR: dist
        run: |
          bash scripts/build_sdk_aarch64.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hf-tokenizer-sdk-${{ matrix.arch }}
          path: |
            dist/hf-tokenizer-sdk-${{ matrix.arch }}.tar.gz
            dist/hf-tokenizer-sdk-${{ matrix.arch }}.tar.gz.sha256

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # ✅ 用官方/常用 action 管 Rust，不在脚本里装
      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Setup MSYS2 (mingw64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            git
            zip
            unzip

      - name: Build SDK (windows x86_64, mingw64)
        shell: msys2 {0}
        env:
          TARGET: x86_64-pc-windows-gnu
          SDK_NAME: hf-tokenizer-sdk-windows-x86_64
          OUT_DIR: dist
        run: |
          set -euo pipefail

          # Rust tools
          export PATH="/c/Users/runneradmin/.cargo/bin:$PATH"

          # 强制用 MSYS2 MinGW64 的 bin（非常关键）
          export PATH="/mingw64/bin:$PATH"

          # 让 cc-rs 用到存在的工具名（MINGW64 里通常就是 ar/ranlib/gcc）
          export CC=gcc
          export CXX=g++
          export AR=ar
          export RANLIB=ranlib

          which gcc
          which ar
          which ranlib
          gcc --version
          ar --version

          bash scripts/build_sdk_windows_mingw64.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hf-tokenizer-sdk-windows-x86_64
          path: |
            dist/hf-tokenizer-sdk-windows-x86_64.zip
            dist/hf-tokenizer-sdk-windows-x86_64.zip.sha256

  # 版本 tag 发布（排除固定 tag v0.1.0）
  release:
    if: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref != 'refs/tags/v0.1.0' }}
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist_artifacts

      - name: List artifacts
        run: |
          ls -R dist_artifacts

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist_artifacts/hf-tokenizer-sdk-x86_64/hf-tokenizer-sdk-x86_64.tar.gz
            dist_artifacts/hf-tokenizer-sdk-x86_64/hf-tokenizer-sdk-x86_64.tar.gz.sha256
            dist_artifacts/hf-tokenizer-sdk-aarch64/hf-tokenizer-sdk-aarch64.tar.gz
            dist_artifacts/hf-tokenizer-sdk-aarch64/hf-tokenizer-sdk-aarch64.tar.gz.sha256
            dist_artifacts/hf-tokenizer-sdk-windows-x86_64/hf-tokenizer-sdk-windows-x86_64.zip
            dist_artifacts/hf-tokenizer-sdk-windows-x86_64/hf-tokenizer-sdk-windows-x86_64.zip.sha256

  # main 每次成功构建后：覆盖固定 tag v0.1.0 的 release assets（不移动 tag）
  fixed_release:
    if: ${{ github.ref == 'refs/heads/main' }}
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist_artifacts

      - name: List artifacts
        run: |
          ls -R dist_artifacts

      - name: Update fixed tag and clobber release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${FIXED_TAG}"

          # 如果你不想“移动 tag”，把下面两行注释掉即可（只覆盖 Release assets）
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f "${TAG}" "${GITHUB_SHA}"
          git push -f origin "refs/tags/${TAG}"

          # 确保 release 存在（没有就创建）
          gh release view "${TAG}" >/dev/null 2>&1 || \
            gh release create "${TAG}" -t "${TAG}" -n "Auto-updated from main" --target "${GITHUB_SHA}"

          # 覆盖上传同名 assets
          gh release upload "${TAG}" \
            dist_artifacts/hf-tokenizer-sdk-x86_64/hf-tokenizer-sdk-x86_64.tar.gz \
            dist_artifacts/hf-tokenizer-sdk-x86_64/hf-tokenizer-sdk-x86_64.tar.gz.sha256 \
            dist_artifacts/hf-tokenizer-sdk-aarch64/hf-tokenizer-sdk-aarch64.tar.gz \
            dist_artifacts/hf-tokenizer-sdk-aarch64/hf-tokenizer-sdk-aarch64.tar.gz.sha256 \
            dist_artifacts/hf-tokenizer-sdk-windows-x86_64/hf-tokenizer-sdk-windows-x86_64.zip \
            dist_artifacts/hf-tokenizer-sdk-windows-x86_64/hf-tokenizer-sdk-windows-x86_64.zip.sha256 \
            --clobber
